 URL : "https://github.com/idealista/airflow-role/issues/17" TITLE : molecule using docker BODY : in order to use travis and molecule, it is mandatory to use docker: travis doesn't support vagrant. the problem was that the tests use ansible module and it needs an ansible backend connection and, when docker driver is specified, molecule uses testinfra with the argument --connection=docker , making the tests fail, as they don't find any host. to make it work, we just have to force testinfra to use the same arguments as the vagrant driver. these arguments are: --connection=ansible --ansible-inventory=.molecule/ansible_inventory , so in molecule.yml , we specify these arguments in verifier section: yaml verifier: name: testinfra options: connection: ansible ansible-inventory: .molecule/ansible_inventory docker driver configuration is a bit tricky itself: as our role is using systemd , default image configuration won't work. to make docker container use systemd , we have to add this in the container configuration in molecule.yml : yaml privileged: true cap_add: - sys_admin volume_mounts: - '/sys/fs/cgroup:/sys/fs/cgroup:ro' command: '/lib/systemd/systemd' finally, looks like default debian images come with python 2.7.9 and it makes pip crack somehow after airflow installation, so we have to use python images. knowing all of this, the docker section in molecule.yml states like this: yaml docker: containers: - name: airflow.vm ansible_groups: - airflow image: python image_version: 2.7.13-jessie port_bindings: 80: 80 8080: 8080 5555: 5555 privileged: true cap_add: - sys_admin volume_mounts: - '/sys/fs/cgroup:/sys/fs/cgroup:ro' command: '/lib/systemd/systemd'