 URL : "https://github.com/influxdata/telegraf/issues/2382" TITLE : remove sleep from tests BODY : bug report steps to reproduce: 1. run the tests on all plugins expected behavior: all pass actual behavior: occasionally some will fail, such as: --- fail: testrunparserandgatherjson 0.14s error trace:	accumulator.go:234 mqtt_consumer_test.go:183 error: unknown measurement nats_json_test fail additional info: many of the plugin tests use time.sleep to give their goroutines time to process data. this is a bad idea as it makes the test take longer, and the times may not be adequate to avoid failures. unfortunately go test -race doesn't detect these issues, because the plugins are using methods such as acc.assertcontainstaggedfields and acc.nmetrics , which use locks and atomic operations. it's just that the locks are being grabbed before the goroutines have time to call acc.addfields . b3537ef2 added a testutil.accumulator.wait method which should alleviate the majority of the need for sleep statements. we might want to provide a convenience function though to avoid the need for: acc.lock if acc.nmetrics == 0 { acc.wait } acc.unlock but it's not that much code, so i'm not completely convinced of the need. however it does seem like we need something similar to acc.wait such as acc.waiterror . i've seen some tests which are doing time.sleep and expecting an error to happen.