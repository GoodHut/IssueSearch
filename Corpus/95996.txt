 URL : "https://github.com/ClevelandArtGIT/cma-archives/issues/84" TITLE : download url adds extra id BODY : problem when running rspec tests calls to sufia::engine.routes.url_helpers.download_url are eventually corrupted with an extra id that causes tests to fail. this does not appear to be affecting production usage. failures: 1 ingestlocalfilejob run copies the file into the local repository failure/error: expect file.content.mime_type .to eq message/external_body; access-type=url; url=\ http://localhost:3000/downloads/ {file.id}\ expected: message/external_body; access-type=url; url=\ http://localhost:3000/downloads/jq085k51z\ got: message/external_body; access-type=url; url=\ http://localhost:3000/downloads/cv43nx37f.jq085k51z\ compared using == ./spec/jobs/ingest_local_file_job_spec.rb:23:in block 3 levels in <top required >' replication download the code base then run bin/rspec spec/ . if you only execute spec/jobs/ingest_local_file_job_spec.rb it will pass. if this test runs early in a full suite of tests it will also pass. at some indeterminate state the method is corrupted. any future calls to localfileurlservice.download_url will insert an extra id in every future request. see https://gist.github.com/narogers/d5952f65e827fd6979b743a4a994cb16 for an captured example. solution sufia::engine.routes.url_helpers.download_url should behave reliably by returning only the id that was provided without any extra information in the url.